<!DOCTYPE html>
<html lang="pl-PL">
<head>
    <meta charset="UTF-8">
    <title>Pliki Atluscika</title>
    <script>
        // TWOJE DANE ZWERYFIKOWANE
        const UPLOADCARE_PUBLIC_KEY = '6b42d984d10961c51a51';
        const JSONBIN_BIN_ID = '6984e6c243b1c97be9682823';
        const JSONBIN_KEY = '$2a$10$jUG8DCYFDuiomPU7qoC0f.1kD30WGYv4rMtjB/k8h0MnG6qV8ZISK';
    </script>
    <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #eee; text-align: center; padding: 20px; }
        .box { background: #1e1e1e; padding: 30px; border-radius: 15px; max-width: 500px; margin: 0 auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border: 1px solid #333; }
        h1 { color: #fff; }
        #fileList { list-style: none; padding: 0; margin-top: 25px; text-align: left; }
        #fileList li { background: #2a2a2a; margin: 10px 0; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .btn-download { background: #007bff; color: white; text-decoration: none; padding: 5px 15px; border-radius: 5px; font-size: 14px; }
        .btn-download:hover { background: #0056b3; }
        .status { color: #888; font-style: italic; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="box">
    <h1>Pliki do pobrania</h1>
    <p>Dodaj plik, a pojawi się on u każdego!</p>
    
    <input type="hidden" role="uploadcare-uploader" id="uploader" data-public-key="6b42d984d10961c51a51" />
    
    <ul id="fileList"><li class="status">Ładowanie listy plików...</li></ul>
</div>

<script>
    const widget = uploadcare.Widget('#uploader');
    const listElement = document.getElementById('fileList');

    // 1. POBIERANIE LISTY Z CHMURY
    async function loadFiles() {
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                headers: { 'X-Master-Key': JSONBIN_KEY }
            });
            const data = await response.json();
            
            // Obsługa różnych formatów zapisu w JSONbin
            const files = Array.isArray(data.record) ? data.record : (data.record.files || []);

            listElement.innerHTML = '';
            if (files.length === 0) {
                listElement.innerHTML = '<li class="status">Brak plików na liście.</li>';
            }

            files.forEach(file => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${file.name}</span> <a href="${file.url}" class="btn-download" target="_blank">Pobierz</a>`;
                listElement.appendChild(li);
            });
        } catch (e) {
            console.error(e);
            listElement.innerHTML = '<li class="status" style="color:red;">Błąd połączenia z bazą danych.</li>';
        }
    }

    // 2. WYSYŁANIE I AKTUALIZACJA LISTY
    widget.onUploadComplete(async (info) => {
        listElement.innerHTML = '<li class="status">Zapisywanie w chmurze...</li>';
        
        try {
            // Pobierz aktualną listę
            const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                headers: { 'X-Master-Key': JSONBIN_KEY }
            });
            const data = await response.json();
            let currentFiles = Array.isArray(data.record) ? data.record : (data.record.files || []);

            // Dodaj nowy plik do listy
            currentFiles.push({ name: info.name, url: info.originalUrl });

            // Wyślij zaktualizowaną listę z powrotem
            await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': JSONBIN_KEY
                },
                body: JSON.stringify(currentFiles)
            });

            // Czekamy 1.5 sekundy, żeby JSONbin zdążył przetworzyć dane przed odświeżeniem
            setTimeout(loadFiles, 1500);

        } catch (err) {
            alert("Błąd podczas aktualizacji listy. Odśwież stronę ręcznie.");
            loadFiles();
        }
    });

    // Startowe ładowanie
    loadFiles();
</script>

</body>
</html>
