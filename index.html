<!DOCTYPE html>
<html lang="pl-PL">
<head>
    <meta charset="UTF-8">
    <title>Pliki Atluscika</title>
    <script>
        // TWOJE DANE
        const UPLOADCARE_PUBLIC_KEY = '6b42d984d10961c51a51';
        const JSONBIN_BIN_ID = '6984e6c243b1c97be9682823';
        const JSONBIN_KEY = '$2a$10$jUG8DCYFDuiomPU7qoC0f.1kD30WGYv4rMtjB/k8h0MnG6qV8ZISK';
    </script>
    <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: #eee; text-align: center; padding: 20px; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .box { background: #181818; padding: 30px; border-radius: 20px; max-width: 450px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.6); border: 1px solid #333; }
        h1 { margin-top: 0; font-size: 1.8rem; }
        #fileList { list-style: none; padding: 0; margin-top: 25px; text-align: left; }
        #fileList li { background: #222; margin: 8px 0; padding: 12px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; }
        .btn-download { background: #007bff; color: white; text-decoration: none; padding: 6px 14px; border-radius: 6px; font-size: 13px; font-weight: bold; }
        .btn-download:hover { background: #0056b3; }
        .status { color: #888; font-style: italic; font-size: 0.9em; padding: 10px; text-align: center; }
        .error { color: #ff4d4d !important; font-weight: bold; }
    </style>
</head>
<body>

<div class="box">
    <h1>Pliki do pobrania</h1>
    <p style="color: #aaa; font-size: 0.9em;">Wspólna lista dla wszystkich użytkowników</p>
    
    <input type="hidden" role="uploadcare-uploader" id="uploader" data-public-key="6b42d984d10961c51a51" />
    
    <ul id="fileList"><li class="status">Inicjalizacja bazy danych...</li></ul>
</div>

<script>
    const widget = uploadcare.Widget('#uploader');
    const listElement = document.getElementById('fileList');

    // 1. POBIERANIE LISTY
    async function loadFiles() {
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                headers: { 'X-Master-Key': JSONBIN_KEY, 'X-Bin-Meta': 'false' }
            });

            if (!response.ok) throw new Error("Błąd serwera");
            
            let files = await response.json();
            
            // Obsługa różnych formatów (obiekt z kluczem files lub czysta tablica)
            if (files.files) files = files.files;
            if (!Array.isArray(files)) files = [];

            listElement.innerHTML = '';
            if (files.length === 0) {
                listElement.innerHTML = '<li class="status">Lista jest obecnie pusta.</li>';
            } else {
                files.reverse().forEach(file => { // Najnowsze na górze
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${file.name}</span> <a href="${file.url}" class="btn-download" target="_blank">Pobierz</a>`;
                    listElement.appendChild(li);
                });
            }
        } catch (e) {
            console.error(e);
            listElement.innerHTML = '<li class="status error">Błąd połączenia. Spróbuj odświeżyć stronę (F5).</li>';
        }
    }

    // 2. WYSYŁANIE
    widget.onUploadComplete(async (info) => {
        listElement.innerHTML = '<li class="status">Synchronizacja z chmurą...</li>';
        
        try {
            const getResp = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                headers: { 'X-Master-Key': JSONBIN_KEY, 'X-Bin-Meta': 'false' }
            });
            let data = await getResp.json();
            let currentFiles = data.files || (Array.isArray(data) ? data : []);

            currentFiles.push({ name: info.name, url: info.originalUrl });

            const putResp = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_KEY },
                body: JSON.stringify({ files: currentFiles })
            });

            if (putResp.ok) {
                setTimeout(loadFiles, 1000);
            } else {
                throw new Error("Błąd zapisu");
            }

        } catch (err) {
            alert("Nie udało się zaktualizować listy. Plik został wysłany, ale odśwież stronę ręcznie.");
            loadFiles();
        }
    });

    loadFiles();
</script>

</body>
</html>
