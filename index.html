<!DOCTYPE html>
<html lang="pl-PL">
<head>
    <meta charset="UTF-8">
    <title>Wspólne Pliki</title>
    <script>
        const UPLOADCARE_PUBLIC_KEY = '6b42d984d10961c51a51';
        const JSONBIN_BIN_ID = '6984e6c243b1c97be9682823';
        const JSONBIN_KEY = '$2a$10$jUG8DCYFDuiomPU7qoC0f.1kD30WGYv4rMtjB/k8h0MnG6qV8ZISK';
    </script>
    <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #0b0b0b; color: #fff; text-align: center; padding: 20px; }
        .box { background: #161616; padding: 30px; border-radius: 20px; max-width: 450px; margin: 40px auto; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #fileList { list-style: none; padding: 0; margin-top: 25px; }
        #fileList li { background: #222; margin: 10px 0; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; }
        .download-link { background: #007bff; color: white; text-decoration: none; padding: 7px 15px; border-radius: 8px; font-weight: bold; font-size: 13px; }
        .loading { color: #888; font-style: italic; }
    </style>
</head>
<body>

<div class="box">
    <h1>Podaj Plik Dalej</h1>
    <p style="color:#888">Wszystko co wrzucisz, widzą inni.</p>
    
    <input type="hidden" role="uploadcare-uploader" id="uploader" data-public-key="6b42d984d10961c51a51" />
    
    <ul id="fileList"><li class="loading">Sprawdzanie połączenia z bazą...</li></ul>
</div>

<script>
    const widget = uploadcare.Widget('#uploader');
    const listElement = document.getElementById('fileList');

    async function loadFiles() {
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                headers: { 
                    'X-Master-Key': JSONBIN_KEY,
                    'X-Bin-Meta': 'false'
                }
            });
            const data = await response.json();
            
            // Obsługa różnych formatów danych
            let files = data.files || (Array.isArray(data) ? data : []);

            if (files.length === 0) {
                listElement.innerHTML = '<li class="loading">Lista jest pusta. Wrzuć pierwszy plik!</li>';
            } else {
                listElement.innerHTML = '';
                files.reverse().forEach(file => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${file.name}</span> <a href="${file.url}" class="download-link" target="_blank">Pobierz</a>`;
                    listElement.appendChild(li);
                });
            }
        } catch (e) {
            listElement.innerHTML = '<li style="color:#ff4d4d">Błąd bazy danych. Spróbuj odświeżyć (F5).</li>';
        }
    }

    widget.onUploadComplete(async (info) => {
        listElement.innerHTML = '<li class="loading">Aktualizowanie listy plików...</li>';
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                headers: { 'X-Master-Key': JSONBIN_KEY, 'X-Bin-Meta': 'false' }
            });
            let data = await res.json();
            let currentFiles = data.files || (Array.isArray(data) ? data : []);

            currentFiles.push({ name: info.name, url: info.originalUrl });

            const update = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Master-Key': JSONBIN_KEY 
                },
                body: JSON.stringify({ files: currentFiles })
            });

            if (update.ok) {
                loadFiles(); // Odśwież listę bez przeładowania strony
            }
        } catch (err) {
            alert("Plik wysłany, ale wystąpił błąd zapisu na liście. Odśwież stronę.");
        }
    });

    loadFiles();
</script>
</body>
</html>
