<!DOCTYPE html>
<html lang="pl-PL">
<head>
    <meta charset="UTF-8">
    <title>Pliki Atluscika</title>
    <script>
        const UPLOADCARE_PUBLIC_KEY = '6b42d984d10961c51a51';
        const JSONBIN_BIN_ID = '6984e6c243b1c97be9682823';
        const JSONBIN_KEY = '$2a$10$jUG8DCYFDuiomPU7qoC0f.1kD30WGYv4rMtjB/k8h0MnG6qV8ZISK';
    </script>
    <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #111; color: #eee; text-align: center; padding: 20px; }
        .box { background: #1e1e1e; padding: 25px; border-radius: 15px; max-width: 450px; margin: auto; border: 1px solid #333; }
        #fileList { list-style: none; padding: 0; margin-top: 20px; }
        #fileList li { background: #252525; margin: 8px 0; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; border: 1px solid #444; }
        .btn { background: #007bff; color: white; text-decoration: none; padding: 5px 12px; border-radius: 5px; font-size: 13px; }
    </style>
</head>
<body>
    <div class="box">
        <h1>Wspólne Pliki</h1>
        <input type="hidden" role="uploadcare-uploader" id="uploader" data-public-key="6b42d984d10961c51a51" />
        <ul id="fileList">Ładowanie...</ul>
    </div>

<script>
    const widget = uploadcare.Widget('#uploader');
    const listElement = document.getElementById('fileList');

    async function loadFiles() {
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                headers: { 'X-Master-Key': JSONBIN_KEY, 'X-Bin-Meta': 'false' }
            });
            const data = await response.json();
            
            // Inteligentne szukanie listy plików w danych z JSONbin
            let files = [];
            if (Array.isArray(data)) files = data;
            else if (data.files && Array.isArray(data.files)) files = data.files;
            else if (data.record && Array.isArray(data.record.files)) files = data.record.files;

            listElement.innerHTML = files.length === 0 ? '<li>Lista jest pusta.</li>' : '';
            files.forEach(file => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${file.name}</span> <a href="${file.url}" class="btn" target="_blank">Pobierz</a>`;
                listElement.appendChild(li);
            });
        } catch (e) {
            listElement.innerHTML = '<li style="color:red">Błąd bazy. Sprawdź JSONbin!</li>';
        }
    }

    widget.onUploadComplete(async (info) => {
        listElement.innerHTML = '<li>Zapisywanie linku...</li>';
        try {
            const resp = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                headers: { 'X-Master-Key': JSONBIN_KEY, 'X-Bin-Meta': 'false' }
            });
            let data = await resp.json();
            let currentFiles = data.files || (Array.isArray(data) ? data : []);
            
            currentFiles.push({ name: info.name, url: info.originalUrl });

            await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_KEY },
                body: JSON.stringify({ files: currentFiles })
            });
            setTimeout(loadFiles, 1000);
        } catch (err) {
            alert("Błąd zapisu linku. Odśwież stronę.");
            loadFiles();
        }
    });

    loadFiles();
</script>
</body>
</html>
